<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>hololisp</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User guide</li><li class="chapter-item expanded "><a href="guide/compiling.html"><strong aria-hidden="true">2.</strong> Compiling</a></li><li class="chapter-item expanded "><a href="guide/run.html"><strong aria-hidden="true">3.</strong> Running</a></li><li class="chapter-item expanded affix "><li class="part-title">Language description</li><li class="chapter-item expanded "><a href="spec/design.html"><strong aria-hidden="true">4.</strong> Design</a></li><li class="chapter-item expanded "><a href="spec/syntax.html"><strong aria-hidden="true">5.</strong> Syntax</a></li><li class="chapter-item expanded "><a href="spec/values.html"><strong aria-hidden="true">6.</strong> Values</a></li><li class="chapter-item expanded "><a href="spec/runtime/index.html"><strong aria-hidden="true">7.</strong> Runtime</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="spec/runtime/bytecode.html"><strong aria-hidden="true">7.1.</strong> Bytecode compiler</a></li><li class="chapter-item expanded "><a href="spec/runtime/libraries.html"><strong aria-hidden="true">7.2.</strong> Libraries</a></li></ol></li><li class="chapter-item expanded "><a href="spec/s-expr/index.html"><strong aria-hidden="true">8.</strong> Lisp forms</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="spec/s-expr/builtin.html"><strong aria-hidden="true">8.1.</strong> Compiler builtins</a></li><li class="chapter-item expanded "><a href="spec/s-expr/intern.html"><strong aria-hidden="true">8.2.</strong> Intern functions</a></li><li class="chapter-item expanded "><a href="spec/s-expr/functional.html"><strong aria-hidden="true">8.3.</strong> Functional library</a></li><li class="chapter-item expanded "><a href="spec/s-expr/macros.html"><strong aria-hidden="true">8.4.</strong> Macro system</a></li><li class="chapter-item expanded "><a href="spec/s-expr/c-ffi.html"><strong aria-hidden="true">8.5.</strong> C FFI</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Conclusion</li><li class="chapter-item expanded "><a href="results.html"><strong aria-hidden="true">9.</strong> Results</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">hololisp</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the <em>hololisp book</em>, a description of a toy programming language hololisp. hololisp is a freestanding lisp dialect, having ideas taken from multiple other popular dialects with core guideline being to keep things simple.</p>
<h2 id="who-is-this-language-and-book-are-for"><a class="header" href="#who-is-this-language-and-book-are-for">Who is this language and book are for</a></h2>
<p>hololisp may be of interest to programming language enthusiasts and students looking for reference system implementation with thorough description.</p>
<h2 id="about-author"><a class="header" href="#about-author">About author</a></h2>
<p>The author at the time of writing this text is a second-year student at <a href="https://en.wikipedia.org/wiki/Bauman_Moscow_State_Technical_University">BMSTU</a>. During first year in university they became interested in compiler construction and by the year-end were able to start writing this language. During that time they also found a job as an embedded programmer starting professional deep dive in systems programming.</p>
<h2 id="acknowledgements"><a class="header" href="#acknowledgements">Acknowledgements</a></h2>
<p>The code is written mostly without being copied from some other project. That is to say, some parts of it may not be great due to lack of experience. However, it is important to name resources that made writing this language possible.</p>
<ul>
<li><a href="https://craftinginterpreters.com/">Crafting Interpreters</a></li>
<li><a href="https://wren.io/">Wren</a></li>
<li><a href="https://github.com/rui314/minilisp">minilisp</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compiling"><a class="header" href="#compiling">Compiling</a></h1>
<p>hololisp is written in C99 and uses Make as its build system.</p>
<p>For basic usage just run <code>make</code> command and start using build/hololisp as language interpreter.</p>
<h2 id="make-flags"><a class="header" href="#make-flags">Make flags</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name of the option</th><th>Description</th></tr></thead><tbody>
<tr><td>DEBUG</td><td>Specifies whether to compile in debug or release mode</td></tr>
<tr><td>COV</td><td>Collect coverage (for use with gprof)</td></tr>
<tr><td>ASAN</td><td>Compile with Address Sanitizer</td></tr>
<tr><td>STRESS_GC</td><td>Run Garbage Collector on every allocation</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="running"><a class="header" href="#running">Running</a></h1>
<p>hololisp interpreter executable can be used in three modes: REPL, executing script files, and executing command strings.</p>
<p>To execute script pass its name to the program executable:</p>
<pre><code class="language-shell">$ hololisp examples/game_of_life.hl
</code></pre>
<p>REPL session looks like this:</p>
<pre><code class="language-shell">$ hololisp
hololisp&gt; (define x 100)
x
hololisp&gt; x
100
hololisp&gt; (+ x (* x 100))
10100
</code></pre>
<p>To execute command string pass it after <em>-e</em> flag:</p>
<pre><code class="language-shell">$ hololisp -e &quot;(+ 1 2)&quot;
3
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design"><a class="header" href="#design">Design</a></h1>
<blockquote>
<p>hololisp is a toy programming language. It does not have to perform well or use readably and user-friendly syntax as long as it is relatively fun to use and program.</p>
</blockquote>
<h2 id="background-and-motivation"><a class="header" href="#background-and-motivation">Background and motivation</a></h2>
<p>It is common knowledge in programming languages' community that lisp is one of the simplest languages to implement while proving wide range of features. There are a lot of tutorials on the internet that describe how to implement simple lisp dialect interpreter.</p>
<p>All those tutorials, however, do not cover important topics of writing interpreter or cover them partially. This may include garbage collector, tail call unwinding, bytecode and other interesting topics. And, most importantly, they do not try to provide programmer (student) with sense of accomplishment that can be acquired after long hours spent on debugging malformed algorithms, optimizing naive code and spending more time fighting premature optimizations and improving on architectural imperfections.</p>
<p>This project does not try to label itself as a great learning material, but it does go a bit deeper into semi-complex PL topics. Everything is written from scratch without using any libraries mostly to keep things simple and to show that no complexity is ever necessary even when writing seemingly complex application.</p>
<h2 id="language-for-implementation"><a class="header" href="#language-for-implementation">Language for implementation</a></h2>
<p>C language was chosen because that is the language author is most comfortable with. It complicates writing interpreter compared to more higher-level languages while providing more power in low level control over resources.</p>
<p>That is to say, the process of writing language is not straightforward at all and required several sleepless nights spent of debugging memory corruption bugs.</p>
<p>Additional goal set at the start of the project is to create an online compiler/playground, similar to the ones languages like <a href="https://play.rust-lang.org/">Rust</a> and <a href="https://go.dev/play/">Go</a>. For example, Go achieves this by having a web server receiving code from clients, compiling it and sending result. This, of course, is a fine solution for compiled language (although it can be done locally using something like <a href="https://llvm.org/docs/CommandGuide/lli.html">llvm bitcode interpreter</a>). More simple solution it case of interpreted language was decided to be <a href="https://webassembly.org/">WebAssembly</a>. Long story short, we can compile our C code and call it from browser directly.</p>
<h2 id="language-design"><a class="header" href="#language-design">Language design</a></h2>
<p>hololisp does not have discrete specification. It is a freestanding interpretation of ideas found in other lisp dialect. hololisp borrows ideas both from <a href="https://common-lisp.net/">common lisp</a> and <a href="https://www.scheme.com/tspl4/">scheme</a>. More information about language features is located in next chapter.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="syntax"><a class="header" href="#syntax">Syntax</a></h1>
<p>hololisp is based on <a href="https://en.wikipedia.org/wiki/S-expression">s-expressions</a>. S-expressions are defined recursively as a list of items enclosed in parentheses.</p>
<h2 id="lexical-grammar"><a class="header" href="#lexical-grammar">Lexical grammar</a></h2>
<pre><code>token:
    symbol
    number
    dot
    lparen
    rparen
    quote
    
symbol:
    symbol-nondigit
    symbol symbol-nondigit
    symbol digit
    digit
    symbol dot
    dot symbol
    
symbol-nondigit: one of
    a b c d e f g h i j k l m
    n o p q r s t u v w x y z
    A B C D E F G H I J K L M
    N O P Q R S T U V W X Y Z
    * / @ $ % ^ &amp; _ = &lt; &gt; ~ ? 
    ! [ ] { } 
    sign
   
digit: one of
    0 1 2 3 4 5 6 7 8 9 
    
sign:
    + -
    
dot: 
    .
    
number:
    sign number-consant
    number-constant
    
number-consant:
    digit 
    number-constant digit
   
lparen:
    (
    
rparen:
    )
    
quote:
    '
</code></pre>
<p>Lexer is coded using FSM based on two-action loop parsing and finaliziation of token after that. For more information please refer to <a href="https://nothings.org/computer/lexing.html">Some Strategies For Fast Lexical Analysis when Parsing Programming Languages</a>.</p>
<pre><code class="language-c">// hll_compiler.c

const char *token_start = cursor;
enum hll_lexer_state state = HLL_LEX_START;
do {
    // Basic state machine-based lexing.
    // It has been decided to use character equivalence classes in hope that
    // lexical grammar stays simple. In cases like C grammar, there are a
    // lot of special cases that are better be handled by per-codepoint
    // lookup.
    enum hll_lexer_equivalence_class eqc = get_equivalence_class(*cursor++);
    // Decides what state should go next based on current state and new
    // character.
    state = get_next_state(state, eqc);
    // If character we just parsed means that token is not yet started (for
    // example, if we encounter spaces), increment token start to adjust for
    // that. If it happens that we allow other non-significant characters,
    // this should better be turned into an array lookup.
    token_start += state == HLL_LEX_START;
} while (state &lt; HLL_LEX_FIN);

switch (state) {
    // finalize ...
}
</code></pre>
<h2 id="syntax-1"><a class="header" href="#syntax-1">Syntax</a></h2>
<pre><code>list:
    nil
    lparen list-body rparen
    
list-body:
    atom
    list-body atom
    list-body dot atom
    
atom:
    list
    symbol
    number
    quote atom
    
nil:
    lparen rparen
    
t:
    symbol &quot;t&quot;
</code></pre>
<p>Parsing is done using naive recursive-descent parses that builds AST.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="values"><a class="header" href="#values">Values</a></h1>
<blockquote>
<p>By 'value' we understand minimal instance of hololisp object that language can operate on.</p>
</blockquote>
<p>Hololisp currently supports several types of values:</p>
<ul>
<li>conses</li>
<li>symbols</li>
<li>numbers</li>
<li>functions (and macros)</li>
<li>nil</li>
<li>true</li>
<li>C FFI function</li>
<li>env</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="runtime"><a class="header" href="#runtime">Runtime</a></h1>
<p>Despite hololisp being interpreted language, it does compile to bytecode prior to execution, similar to <a href="https://www.lua.org/">Lua</a>. This allows for much faster code execution than naive AST walker. Additionally, it allows doing several operations that require control over program execution, like performing optimizations (tail call unwinding) and doing garbage collection (it is possible to do in ast walker using very nasty hacks).</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
